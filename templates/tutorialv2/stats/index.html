{% extends "tutorialv2/base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load append_query_params %}
{% load date_from_day_number %}
{% load seconds_to_duration %}

{% block title %}
    {% trans "Statistiques du contenu" %}
{% endblock %}

{% block breadcrumb %}
    <li><a href="{% url "content:stats-content" content.pk content.slug %}">{% trans "Statistiques" %}</a></li>
    <li>{{ content.title }}</li>
{% endblock %}

{% block content_out %}
    <!--TODO those should not be needed -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <section class="full-content-wrapper">
        <h2 class="ico-after ico-tutorials">
            {% if display == 'global' %}
                    {% blocktrans with content_title=content.title %}
                            Statistiques du contenu : {{content_title}}
                    {% endblocktrans %}
            {% elif display == 'details' %}
                    {% blocktrans with content_title=content.title %}
                        Détails des statistiques du contenu : {{content_title}}
                    {% endblocktrans %}
            {% elif display == 'comparison' %}
                    {% blocktrans with content_title=content.title %}
                            Comparaison de plusieurs urls du contenu : {{content_title}}
                    {% endblocktrans %}
            {% endif %}
        </h2>

        <div class="stat-graph-container">
            <div class="stat-graph">
                <!-- TODO nice to have, template tag to serialize those array, use built-in template tag ??? -->
                <p>{% trans "Évolution des pages vues sur le contenu" %}</p>
                <canvas id="view-graph"
                    {% for url in stats %}
                        data-views-{{ forloop.counter0 }}="[{% for view in url.stats.pageviews %}{{view.pageviews}} {% if not forloop.last %},{% endif %}{% endfor %}]"
                        data-label-views-{{ forloop.counter0 }}="{{url.label}}"
                    {% endfor %}
                    data-time='[{% for view in stats.0.stats.pageviews %}"{{view.date}}"{% if not forloop.last %},{% endif %} {% endfor %}]'">
                </canvas>

            </div>
            <div class="stat-graph">
                <p>{% trans "Évolution du temps de lecture" %}</p>
                <canvas id="visit-time-graph"
                    {% for url in stats %}
                        data-views-{{ forloop.counter0 }}="[{% for view in url.stats.avgTimeOnPage %}{{view.avgTimeOnPage}} {% if not forloop.last %},{% endif %}{% endfor %}]"
                        data-label-views-{{ forloop.counter0 }}="{{url.label}}"
                    {% endfor %}
                    data-time='[{% for view in stats.0.stats.avgTimeOnPage %}"{{view.date}}"{% if not forloop.last %},{% endif %} {% endfor %}]'">
                </canvas>
            </div>
        </div>
        {% if cumulative_stats_by_url %}
            {% if display == 'global' %}
                {% if form.non_field_errors %}
                    <p class="content-wrapper alert-box warning">
                        {{ form.non_field_errors.as_text }}
                    </p>
                {% endif %}
                <form method="post">
                    {% csrf_token %}
            {% endif %}
            <table class="stat-table fullwidth">
                <thead>
                    <th>{% trans "Partie" %}</th>
                    <th>{% trans "Vues" %}</th>
                    <th>{% trans "Temps moyen sur la page" %}</th>
                    <th>{% trans "Visiteurs (Nouveaux)" %}</th>
                    <th>{% trans "Sessions" %}</th>
                    {% if display == 'global' %}<th></th>{% endif %}
                </thead>
                <tbody>
                    {% for view in cumulative_stats_by_url %}
                        <tr>
                            <td class="level-{{view.url.level}}">
                                <a href="{{ view.url.url }}">{{ view.url.name }}</a>
                                {% if display != 'details' %}
                                - <a href="?urls={{view.url.url }}" >(détails)</a>
                                {% endif %}
                            </td>
                            <td>{{ view.pageviews }}</td>
                            <td>{{ view.avgTimeOnPage|seconds_to_duration }}</td>
                            <td>{{ view.users }} ({{ view.newUsers }})</td>
                            <td>{{ view.sessions }}</td>
                            {% if display == 'global' %}
                                <td><input name="urls" id="id_urls_{{forloop.counter1}}" value="{{ view.url.url }}" type="checkbox"></td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if display == 'global' %}
                <button type="submit" class="btn">{% trans "Comparer" %}</button>
                </form>
            {% endif %}
        {% else %}
            {% trans "Aucune statistique a afficher" %}
        {% endif %}

        {% if display == 'comparison' %}
            <!-- TODO bouton retourner au mode global -->
        {% endif %}
        <hr class="clearfix">
        <div>
            <section class="content-col-2">
                <h2>Liens entrants vers ces pages</h2>
                <table class="stat-table fullwidth">
                    <thead>
                        <th>{% trans "Liens" %}</th>
                        <th>{% trans "Visites" %}</th>
                    </thead>
                    <tbody>
                    {% for referrer, visits in referrers.items %}
                        <tr>
                            <td>{{ referrer }}</td>
                            <td>{{ visits }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </section>
            <section class="content-col-2">
                <h2>Mots-clés des moteurs de recherche vers ces pages</h2>
                <table class="stat-table fullwidth">
                        <thead>
                            <th>{% trans "Liens" %}</th>
                            <th>{% trans "Visites" %}</th>
                        </thead>
                        <tbody>
                        {% for keyword, visits in keywords.items %}
                            <tr>
                                <td>{{ keyword }}</td>
                                <td>{{ visits }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
            </section>
        </div>
        <hr class="clearfix">
        <div>
            <h2>Lexique</h2>
            <h3>Visiteurs</h3>
            <p>
                Les Visiteurs, parfois appelé VU ou Visiteurs Uniques, correspondent au nombre d’utilisateurs uniques ayant consulté votre site. Un visiteur est considéré comme nouveau s’il c’est son premier passage sur la page. La mesure de Google est plutôt fiable sur le dédoublonnage grâce à ces outils de tracking poussés. Cependant elle ne doit pas être pris pour valeur exacte (l’outil n’étant par exemple pas considéré comme outil de mesure d’audience parfait par certains organismes officiels)
            </p>
            <h3>Sessions</h3>
            <p>
                Les sessions sont une mesure similaire au visite. Elles symbolisent le passage d’un visiteur. Tant que le visiteur est sur le site et actif, une seule session est comptée. Si l’utilisateur ne fait rien ou quitte le site pendant plus de 5 minutes, alors une nouvelle session démarre.
            </p>
            <h3>Vues</h3>
            <p>
                C’est simplement le nombre de fois qu’une page a été chargée.
            </p>
        </div>

    </section>
{% endblock %}

{% block sidebar %}
    <aside class="sidebar summary mobile-menu-hide">
        <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Actions">
            <h3>{% trans "Échelle de temps" %}</h3>
            <ul>
                <li>
                    {% date_from_day_number 7 as start_date %}
                    <a class="ico-after gear {% if request.GET.start_date == start_date|date:'Y-m-d' or request.GET.start_date is none %}selected{% endif %}"
                       href="{% append_query_params start_date=start_date %}{% if display == 'comparison' %}{% for url in urls %}&urls={{url.url}}{% endfor %}{% endif %}">
                        <span>
                            {% trans "7 derniers jours" %}
                        </span>
                    </a>
                </li>
                <li>
                    {% date_from_day_number 30 as start_date %}
                    <a class="ico-after gear {% if request.GET.start_date == start_date|date:'Y-m-d' %}selected{% endif %}"
                       href="{% append_query_params start_date=start_date %}{% if display == 'comparison' %}{% for url in urls %}&urls={{url.url}}{% endfor %}{% endif %}">
                        <span>
                            {% trans "30 derniers jours" %}
                        </span>
                    </a>
                </li>
                <li>
                    {% date_from_day_number 365 as start_date %}
                    <a class="ico-after gear {% if request.GET.start_date == start_date|date:'Y-m-d' %}selected{% endif %}"
                       href="{% append_query_params start_date=start_date %}{% if display == 'comparison' %}{% for url in urls %}&urls={{url.url}}{% endfor %}{% endif %}">
                        <span>
                            {% trans "La dernière année" %}
                        </span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>
{% endblock sidebar %}
