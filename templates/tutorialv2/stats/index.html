{% extends "tutorialv2/base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load append_query_params %}
{% load date_from_day_number %}

{% block title %}
    {% trans "Statistiques du contenu" %}
{% endblock %}

{% block breadcrumb %}
    <li>{% trans "Statistiques" %}</li>
    <li>{{ content.title }}</li>
{% endblock %}

{% block content_out %}
    <!--TODO those should not be needed -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <section class="full-content-wrapper">
        <h2 class="ico-after ico-tutorials">
            {% if display == 'global' %}
                    {% blocktrans with content_title=content.title %}
                            Statistiques du contenu : {{content_title}}
                    {% endblocktrans %}
            {% elif display == 'comparison' %}
                    {% blocktrans with content_title=content.title %}
                            Comparaison de plusieurs urls du contenu : {{content_title}}
                    {% endblocktrans %}
            {% endif %}
        </h2>

        <div class="stat-graph-container">
            <div class="stat-graph">
                <!-- TODO nice to have, template tag to serialize those array, use built-in template tag ??? --->
                <p>{% trans "Évolution des pages vues sur le contenu" %}</p>
                <canvas id="view-graph"
                        {% for url in pageviews %}
                            data-views-{{ forloop.counter0 }}="[{% for view in url.stats %}{{view.pageviews}} {% if not forloop.last %},{% endif %}{% endfor %}]"
                            data-label-views-{{ forloop.counter0 }}="{{url.label}}"
                        {% endfor %}
                        data-time='[{% for view in pageviews.0.stats %}"{{view.date}}"{% if not forloop.last %},{% endif %} {% endfor %}]'">
                </canvas>

            </div>
            <div class="stat-graph">
                <p>{% trans "Évolution du temps de lecture" %}</p>
                <canvas id="visit-time-graph"
                        {% for url in pagetime %}
                            data-views-{{ forloop.counter0 }}="[{% for view in url.stats %}{{view.time}} {% if not forloop.last %},{% endif %}{% endfor %}]"
                            data-label-views-{{ forloop.counter0 }}="{{url.label}}"
                        {% endfor %}
                        data-time='[{% for view in pagetime.0.stats %}"{{view.date}}"{% if not forloop.last %},{% endif %} {% endfor %}]'">
                </canvas>
            </div>
        </div>

        <!--TODO check that a least one stats is available, else display error msg-->
        <table class="fullwidth">
            <thead>
                <th>{% trans "Partie" %}</th>
                <th>{% trans "Vues" %}</th>
                <th class="wide">{% trans "Temps moyen sur la page" %}</th>
            </thead>
            <tbody>
                {% for view in cumulative_stats_by_url %}
                    <tr>
                        <!-- TODO this could be a link to see the details of one url -->
                        <td><a href="{{ view.url.url }}">{{ view.url.name }}</a> - Voir le détails de cette partie</td>
                        <td>{{ view.pageviews }}</td>
                        <td class="wide">{{ view.avgTimeOnPage }}</td>
                        <!-- TODO convert me from seconds to hh:mm:ss if needed --->
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if display == 'comparison' %}
            <!-- TODO bouton retourner au mode global -->
        {% else %}
            <h2>{% trans "Comparer plusieurs pages entres-elles" %}</h2>
            {% crispy form %}
            <!-- TODO better display -->
        {% endif %}

    </section>
{% endblock %}

{% block sidebar %}
    <!-- TODO fix selected class -->
    <aside class="sidebar summary mobile-menu-hide">
        <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Actions">
            <h3>{% trans "Échelle de temps" %}</h3>
            <ul>
                <li>
                    {% date_from_day_number 7 as start_date %}
                    <a class="ico-after gear {% if request.GET.days == '7' or request.GET.days is none %}selected{% endif %}"
                       href="{% append_query_params start_date=start_date %}{% if display != 'global' %}{% for url in urls %}&urls={{url.url}}{% endfor %}{% endif %}">
                        <span>
                            {% trans "7 derniers jours" %}
                        </span>
                    </a>
                </li>
                <li>
                    {% date_from_day_number 30 as start_date %}
                    <a class="ico-after gear {% if request.GET.days == '30' %}selected{% endif %}"
                       href="{% append_query_params start_date=start_date %}{% if display != 'global' %}{% for url in urls %}&urls={{url.url}}{% endfor %}{% endif %}">
                        <span>
                            {% trans "30 derniers jours" %}
                        </span>
                    </a>
                </li>
                <li>
                    {% date_from_day_number 365 as start_date %}
                    <a class="ico-after gear {% if request.GET.days == '365' %}selected{% endif %}"
                       href="{% append_query_params start_date=start_date %}{% if display != 'global' %}{% for url in urls %}&urls={{url.url}}{% endfor %}{% endif %}">
                        <span>
                            {% trans "La dernière année" %}
                        </span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>
{% endblock sidebar %}
