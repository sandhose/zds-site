{% extends "tutorialv2/base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load append_query_params %}

{% block title %}
    {% trans "Statistiques du contenu" %}
{% endblock %}

{% block breadcrumb %}
    <li>{{ content.title }}</li>
{% endblock %}


{% block content_out %}
    <!--TODO those should not be needed -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>

    <section class="full-content-wrapper">

        {% if display == 'global' %}
            <h2 class="ico-after ico-tutorials">
                {% blocktrans with content_title=content.title %}
                        Statistiques du contenu : {{content_title}}
                {% endblocktrans %}
            </h2>

            <div class="stat-graph-container">
                <div class="stat-graph">
                    <canvas id="view-graph"
                            data-time='[{% for view in pageviews %}"{{view.date}}"{% if not forloop.last %},{% endif %}{% endfor %}]'
                            data-views-0="[{% for view in pageviews %}{{view.pageviews}} {% if not forloop.last %},{% endif %}{% endfor %}]"
                            data-label-views-0="{% trans 'Évolution du nombre de pages vues' %}">
                    </canvas>

                </div>

                <div class="stat-graph">
                    <canvas id="visit-time-graph"
                            data-time='[{% for view in pagetime %}"{{view.date}}"{% if not forloop.last %},{% endif %}{% endfor %}]'
                            data-views-0="[{% for view in pagetime %}{{view.time}} {% if not forloop.last %},{% endif %}{% endfor %}]"
                            data-label-views-0="{% trans 'Évolution du temps moyen de lecture' %}">
                    </canvas>
                </div>
            </div>

        {% elif display == 'comparison' %}
            <h2 class="ico-after ico-tutorials">
                {% blocktrans with content_title=content.title %}
                        Comparaison de plusieurs urls du contenu : {{content_title}}
                {% endblocktrans %}
            </h2>

            <div class="stat-graph-container">
                <div class="stat-graph">
                    <canvas id="view-graph-comparison"
                            {% for url in comparison_of_pageviews %}
                                data-views-{{ forloop.counter0 }}="[{% for view in url.stats %}{{view.pageviews}} {% if not forloop.last %},{% endif %}{% endfor %}]"
                                data-label-views-{{ forloop.counter0 }}="{{url.url}}"
                            {% endfor %}
                            data-time='[{% for view in comparison_of_pageviews.0.stats %}"{{view.date}}"{% if not forloop.last %},{% endif %} {% endfor %}]'">
                    </canvas>
                </div>

            </div>

        {% endif %}

        <!--TODO check that a leat one stats is available, else display error msg-->
        <table class="fullwidth">
            <thead>
                <th>{% trans "URL" %}</th>
                <th>{% trans "Vues" %}</th>
                <th class="wide">{% trans "Temps moyen sur la page" %}</th>
            </thead>
            <tbody>
                {% for view in cumulative_stats_by_url %}
                    <tr>

                        <!-- TODO this could be a link to see the details of one url + link to the online version/part/chapter -->
                        <td>{{ view.url }}</td>
                        <td>{{ view.pageviews}}</td>
                        <td class="wide">{{ view.avgTimeOnPage}}</td>
                        <!-- TODO convert me from seconds to hh:mm:ss if needed --->
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if display == 'comparison' %}
            TODO bouton retourner au mode global
        {% else %}
            <h2>{% trans "Comparer deux pages entres-elles" %}</h2>
            {% crispy form %}
            <!-- TODO better display -->
        {% endif %}

    </section>
{% endblock %}

{% block sidebar %}
    <aside class="sidebar summary mobile-menu-hide">
        <div class="mobile-menu-bloc mobile-all-links mobile-show-ico" data-title="Actions">
            <!--TODO add get parameter so that comparison is keep when changing time scale ??? -->
            <h3>{% trans "Échelle de temps" %}</h3>
            <ul>
                <li>
                    <a class="ico-after gear {% if request.GET.days == '7' or request.GET.days is none %}selected{% endif %}" href="{% append_query_params days=7 %}">
                        <span>
                            {% trans "7 derniers jours" %}
                        </span>
                    </a>
                </li>
                <li>
                    <a class="ico-after gear {% if request.GET.days == '30' %}selected{% endif %}" href="{% append_query_params days=30 %}">
                        <span>
                            {% trans "30 derniers jours" %}
                        </span>
                    </a>
                </li>
                <li>
                    <a class="ico-after gear {% if request.GET.days == '365' %}selected{% endif %}" href="{% append_query_params days=365 %}">
                        <span>
                            {% trans "La dernière année" %}
                        </span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>
{% endblock sidebar %}
